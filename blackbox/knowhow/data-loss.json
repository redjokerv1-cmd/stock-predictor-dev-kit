{
  "category": "Data Loss",
  "description": "사용자 데이터가 예기치 않게 삭제되거나 손상되는 경우",
  "severity": "critical",
  "patterns": [
    {
      "id": "loss-001",
      "symptom": "검증 실패 시 빈 데이터로 덮어쓰기",
      "context": "LocalStorage 데이터 로드 시 검증 로직",
      "causes": [
        "검증 실패 시 빈 객체 반환",
        "이후 save 시 빈 객체가 저장됨",
        "기존 데이터 덮어쓰기"
      ],
      "flow": [
        "1. load() 호출",
        "2. validate() 실패 (스키마 변경, 필드 누락 등)",
        "3. return createEmpty() ← 위험!",
        "4. 사용자 조작 (추가/수정)",
        "5. save() 호출",
        "6. 빈 데이터 + 새 항목만 저장",
        "7. 기존 데이터 손실"
      ],
      "solution": {
        "approach": "검증 실패 시 raw 데이터 복구 시도",
        "code_pattern": "try { parse raw → minimal validation → return } catch { return empty }"
      },
      "example": {
        "file": "frontend/src/utils/storage/adapters/portfolio-adapter.ts",
        "commit": "5450309"
      },
      "prevention": [
        "검증 실패 시 바로 빈 객체 반환하지 않기",
        "복구 시도 → 실패 시에만 빈 객체",
        "데이터 변경 전 백업 저장",
        "삭제 작업은 명시적 확인 필요"
      ]
    },
    {
      "id": "loss-002",
      "symptom": "마이그레이션 시 데이터 손실",
      "context": "스토리지 스키마 변경 시",
      "causes": [
        "구버전 데이터 파싱 실패",
        "마이그레이션 로직 버그",
        "구버전 키 삭제 타이밍 오류"
      ],
      "solution": {
        "approach": "마이그레이션 성공 확인 후에만 구버전 삭제",
        "code_pattern": "const migrated = migrate(); if (migrated.success) { remove(oldKey); }"
      },
      "prevention": [
        "마이그레이션 전 백업",
        "마이그레이션 성공 확인 후 삭제",
        "단위 테스트 작성"
      ]
    },
    {
      "id": "loss-003",
      "symptom": "JSON 파싱 실패로 데이터 무시",
      "context": "localStorage.getItem() 후 JSON.parse()",
      "causes": [
        "손상된 JSON 문자열",
        "이전 버전 호환 안됨",
        "catch 블록에서 빈 값 반환"
      ],
      "solution": {
        "approach": "파싱 실패 시 로그 + 원본 보존",
        "code_pattern": "try { parse } catch { log('파싱 실패', raw); return partial_recovery }"
      },
      "prevention": [
        "JSON.parse 실패 시 원본 로깅",
        "부분 복구 시도",
        "데이터 검증 로직 점진적 적용"
      ]
    }
  ],
  "recovery_options": [
    {
      "option": "브라우저 LocalStorage 직접 확인",
      "how": "F12 → Application → Local Storage → 해당 도메인"
    },
    {
      "option": "StorageDebug 도구 사용",
      "how": "StorageDebug.viewPortfolio() 또는 StorageDebug.viewAll()"
    },
    {
      "option": "백업에서 복구",
      "how": "StorageDebug.restore(backupJson)"
    }
  ],
  "debug_commands": [
    "localStorage.getItem('sp-portfolio-v1')",
    "localStorage.getItem('stock-predictor-portfolio')",
    "StorageDebug.viewAll()"
  ],
  "related_rules": ["GEN-005"],
  "updated": "2025-12-11"
}

